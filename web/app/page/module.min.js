cenozoApp.defineModule({name:"page",dependencies:["address","participant","question"],models:["add","list","view"],create:module=>{cenozoApp.initQnairePartModule(module,"page");module.identifier.parent={subject:"module",column:"module.id"};module.addInput("","tabulate",{title:"Tabulate",type:"boolean",help:"Determines whether questions on this page should be organized into a table."});module.addInput("","average_time",{title:"Average Time (seconds)",type:"string",isConstant:true,isExcluded:"add"});module.addInput("","max_time",{title:"Max Time (seconds)",type:"string",format:"integer",isConstant:true,help:"Maximum page time is automatically calculated to exclude major outliers by setting its value to that "+"of the outer fence (3 times the interquartile width above the upper quartile)."});module.addInput("","note",{title:"Note",type:"text"});module.addInput("","qnaire_id",{column:"qnaire.id",isExcluded:true});module.addInput("","qnaire_name",{column:"qnaire.name",isExcluded:true});module.addInput("","total_pages",{column:"qnaire.total_pages",isExcluded:true});module.addInput("","variable_suffix",{column:"qnaire.variable_suffix",isExcluded:true});module.addInput("","debug",{column:"qnaire.debug",isExcluded:true});module.addInput("","problem_report",{column:"qnaire.problem_report",isExcluded:true});module.addInput("","base_language",{column:"base_language.code",isExcluded:true});module.addInput("","prompts",{isExcluded:true});module.addInput("","module_prompts",{isExcluded:true});module.addInput("","popups",{isExcluded:true});module.addInput("","module_popups",{isExcluded:true});module.addInput("","module_id",{isExcluded:true});module.addInput("","parent_name",{column:"module.name",isExcluded:true});cenozo.insertPropertyAfter(module.columnList,"name","tabulate",{title:"Tabulate",type:"boolean"});cenozo.insertPropertyAfter(module.columnList,"question_count","average_time",{title:"Average Time",type:"seconds"});module.addExtraOperation("view",{title:"Preview",operation:async function($state,model){await $state.go("page.render",{identifier:model.viewModel.record.getIdentifier()},{reload:true})}});function searchOptionList(optionList,id){var optionIndex=null;if(angular.isArray(optionList))optionList.some((option,index)=>{if(option==id||angular.isObject(option)&&option.id==id){optionIndex=index;return true}});return optionIndex}cenozo.providers.directive("cnPageClone",["CnQnairePartCloneFactory","CnPageModelFactory","CnSession","$state",function(CnQnairePartCloneFactory,CnPageModelFactory,CnSession,$state){return{templateUrl:cenozoApp.getFileUrl("pine","qnaire_part_clone.tpl.html"),restrict:"E",scope:{model:"=?"},controller:async function($scope){if(angular.isUndefined($scope.model)){$scope.model=CnQnairePartCloneFactory.instance("page");$scope.model.parentModel=CnPageModelFactory.root}await $scope.model.onLoad();CnSession.setBreadcrumbTrail([{title:"Module",go:async function(){await $state.go("module.list")}},{title:$scope.model.parentSourceName,go:async function(){await $state.go("module.view",{identifier:$scope.model.sourceParentId})}},{title:"Pages"},{title:$scope.model.sourceName,go:async function(){await $state.go("page.view",{identifier:$scope.model.sourceId})}},{title:"move/copy"}])}}}]);cenozo.providers.directive("cnPageNavigator",[function(){return{templateUrl:module.getFileUrl("page_navigator.tpl.html"),restrict:"E",scope:{model:"=?",isComplete:"=",placement:"@"},controller:function($scope){$scope.text=function(address){return $scope.model.renderModel.text(address)}}}}]);cenozo.providers.directive("cnPageRender",["CnPageModelFactory","CnTranslationHelper","CnSession","CnHttpFactory","$state","$document",function(CnPageModelFactory,CnTranslationHelper,CnSession,CnHttpFactory,$state,$document){return{templateUrl:module.getFileUrl("render.tpl.html"),restrict:"E",scope:{model:"=?"},link:function(scope,element){element.on("$destroy",()=>angular.isDefined(scope.model)&&scope.model.renderModel.cancelDevicePromises())},controller:async function($scope){if(angular.isUndefined($scope.model))$scope.model=CnPageModelFactory.root;angular.extend($scope,{isComplete:false,text:function(address){return $scope.model.renderModel.text(address)},patch:async function(property){var model=["address1","address2","city","region_id","postcode"].includes(property)?$scope.model.renderModel.addressModel:$scope.model.renderModel.participantModel;if(model.getEditEnabled()){var element=cenozo.getFormElement(property);var valid=model.testFormat(property,model.viewModel.record[property]);if(element){element.$error.format=!valid;cenozo.updateFormElement(element,true)}if(valid){var data={};data[property]=model.viewModel.record[property];await model.viewModel.onPatch(data)}}}});$document.unbind("keydown");$document.bind("keydown",async function(event){if(!$scope.model.renderModel.showHidden||["number","text","textarea"].includes(event.target.type))return;var action=null;if($scope.isComplete&&!$scope.model.renderModel.working&&!$scope.model.renderModel.hotKeyDisabled){if(["ShiftLeft","ShiftRight"].includes(event.code)){$scope.model.renderModel.upperDigitsActivated=true;$scope.$apply()}}});$document.unbind("keyup");$document.bind("keyup",async function(event){if(!$scope.model.renderModel.showHidden||["number","text","textarea"].includes(event.target.type))return;var action=null;if($scope.isComplete&&!$scope.model.renderModel.working&&!$scope.model.renderModel.hotKeyDisabled){if(["ShiftLeft","ShiftRight"].includes(event.code)){$scope.model.renderModel.upperDigitsActivated=false;$scope.$apply()}else{if("Minus"==event.code||"NumpadSubtract"==event.code){if(null!=$scope.model.viewModel.record.previous_id)action="prevPage"}else if("Equal"==event.code||"NumpadAdd"==event.code){if(angular.isUndefined($scope.model.viewModel.record.next_id)||null!=$scope.model.viewModel.record.next_id)action="nextPage"}else if("BracketLeft"==event.code){action="prevQuestion"}else if("BracketRight"==event.code){action="nextQuestion"}else{var match=event.code.match(/^Digit([0-9])$/);if(match){action=parseInt(match[1]);if(0==action)action+=10;if(event.shiftKey)action+=10}}if(null!=action){event.stopPropagation();if(["prevPage","nextPage"].includes(action)){await Promise.all($scope.model.renderModel.writePromiseList);if("prevPage"==action){await $scope.model.renderModel.backup()}else{await $scope.model.renderModel.proceed()}$scope.$apply()}else if(["prevQuestion","nextQuestion"].includes(action)){$scope.model.renderModel.focusQuestion("prevQuestion"==action);$scope.$apply()}else if(null!=action){await $scope.model.renderModel.onDigitHotKey(action);$scope.$apply()}}}}});try{await $scope.model.renderModel.onReady();CnSession.setBreadcrumbTrail([{title:$scope.model.renderModel.data.qnaire_name,go:async function(){await $state.go("qnaire.view",{identifier:$scope.model.renderModel.data.qnaire_id})}},{title:$scope.model.renderModel.data.respondent_name?$scope.model.renderModel.data.respondent_name:"Preview"}])}finally{$scope.isComplete=true}}}}]);cenozo.providers.factory("CnPageRenderFactory",["CnModalConfirmFactory","CnModalMessageFactory","CnModalDatetimeFactory","CnModalInputFactory","CnModalTextFactory","CnModalPreStageFactory","CnSession","CnHttpFactory","CnTranslationHelper","CnAudioRecordingFactory","CnParticipantModelFactory","CnAddressModelFactory","$state","$timeout","$interval","$sce",function(CnModalConfirmFactory,CnModalMessageFactory,CnModalDatetimeFactory,CnModalInputFactory,CnModalTextFactory,CnModalPreStageFactory,CnSession,CnHttpFactory,CnTranslationHelper,CnAudioRecordingFactory,CnParticipantModelFactory,CnAddressModelFactory,$state,$timeout,$interval,$sce){var object=function(parentModel){function formatDate(date){var m=getDate(date);return m?m.format("dddd, MMMM Do YYYY"):null}function formatTime(time){var m=getTime(time);return m?m.format(CnSession.user.use12hourClock?"h:mm a":"HH:mm"):null}function isDkna(value){return angular.isObject(value)&&true===value.dkna}function isRefuse(value){return angular.isObject(value)&&true===value.refuse}function isDknaOrRefuse(value){return angular.isObject(value)&&(true===value.dkna||true===value.refuse)}function getDate(date){if("now"==date)date=moment().format("YYYY-MM-DD");return date&&!angular.isObject(date)?moment(new Date(date)):null}function getTime(time,tz){const match=null==time||isDknaOrRefuse(time)?null:time.match(/^([0-9]+):([0-9]+)$/);if(null!=match){m=angular.isDefined(tz)?moment().tz(tz):moment();m.hour(parseInt(match[1]));m.minute(parseInt(match[2]));m.second(0);time=moment(m).format()}else if("now"==time){m=angular.isDefined(tz)?moment().tz(tz):moment();time=time.format()}return time&&!angular.isObject(time)?moment(new Date(time)):null}function getAttributeNames(precondition){var list=[];if(angular.isString(precondition)){var matches=precondition.match(/@[^@ ]+@|\bshowhidden\b/g);if(null!=matches&&0<matches.length)list=matches.map(m=>m.replace(/@/g,""))}return list}function isTooSmall(type,minimum,value){return null!=minimum&&null!=value&&("number"==type&&!angular.isObject(value)&&value<minimum||"number with unit"==type&&angular.isObject(value)&&angular.isDefined(value.value)&&null!=value.value&&value.value<minimum)}function isTooLarge(type,maximum,value){return null!=maximum&&null!=value&&("number"==type&&!angular.isObject(value)&&value>maximum||"number with unit"==type&&angular.isObject(value)&&angular.isDefined(value.value)&&null!=value.value&&value.value>maximum)}function getUnitListEnum(unitList,languageList,baseLang){if(null==unitList)return null;function getName(input,lang,baseLang){let nameObj=input;if(angular.isString(nameObj)){nameObj={};nameObj[baseLang]=input}return angular.isDefined(nameObj[lang])?nameObj[lang]:angular.isDefined(nameObj[baseLang])?nameObj[baseLang]:null}const data=JSON.parse(unitList);let unitListEnum={};languageList.forEach(language=>{unitListEnum[language.code]=[{value:null,name:CnTranslationHelper.lookupData.misc.choose[language.code]}];if(angular.isArray(data)){data.forEach(item=>{if(angular.isString(item)){unitListEnum[language.code].push({value:item,name:item})}else if(angular.isObject(item)){for(const key in item){const name=getName(item[key],language.code,baseLang);if(null!=name)unitListEnum[language.code].push({value:key,name:name})}}})}else if(angular.isObject(data)){for(const key in data){const name=getName(data[key],language.code,baseLang);if(null!=name)unitListEnum[language.code].push({value:key,name:name})}}});return unitListEnum}async function focusElement(id){var promise=await $interval(()=>{var element=document.getElementById(id);if(null!=element){element.focus();$interval.cancel(promise)}},50,10);return promise}angular.extend(this,{parentModel:parentModel,participantModel:CnParticipantModelFactory.root,addressModel:CnAddressModelFactory.root,prevModuleList:[],nextModuleList:[],working:false,progress:0,previewMode:"respondent"!=parentModel.getSubjectFromState(),data:{token:null,scanned_token:null,response_id:null,participant_id:null,address_id:null,qnaire_id:null,qnaire_name:null,start_datetime:null,end_datetime:null,comments:null,checked_in:null,stage_id:null,page_id:null,stage_selection:null,base_language:null,stages:null,closed:null,submitted:null,respondent_name:null,introductionList:null,conclusionList:null,closedList:null,title:null},responseStageList:null,consentList:null,consentEnumList:[{value:null,name:"(empty)",disabled:true},{value:true,name:"Yes",disabled:false},{value:false,name:"No",disabled:false}],deviationTypeList:null,qnaireReportList:null,languageList:null,showHidden:false,alternateId:null,site:null,username:null,focusQuestionId:null,hotKeyDisabled:false,upperDigitsActivated:false,activeAttributeList:[],questionList:[],optionListById:{},currentLanguage:null,writePromiseList:[],promiseIndex:0,reset:function(){angular.extend(this,{questionList:[],activeAttributeList:[],prevModuleList:[],nextModuleList:[],focusQuestionId:null,devicePromiseList:[]})},cancelDevicePromises:function(){if(angular.isDefined(this.devicePromiseList)){this.devicePromiseList.forEach(promise=>$interval.cancel(promise.promise));this.devicePromiseList=[]}},addDevicePromise:function(question){if("device"==question.type&&"in progress"==question.device_status){const promise=$interval(async()=>{if(question.device_uuid){const response=await CnHttpFactory.instance({path:"answer/"+["token="+$state.params.token,"question_id="+question.id].join(";"),data:{select:{column:["value","files_received",{table:"answer_device",column:"uuid"},{table:"answer_device",column:"status"}]}}}).get();const newValue=angular.fromJson(response.data.value);let changeObj={device_status:response.data.status,device_uuid:response.data.uuid};if(newValue!=question.value){angular.extend(changeObj,{value:angular.fromJson(response.data.value),files_received:response.data.files_received,backupValue:angular.copy(response.data.value)})}angular.extend(question,changeObj);var complete=this.questionIsComplete(question);question.incomplete=false===complete?true:true===complete?false:complete;this.evaluateAllDescriptions();if("in progress"!=question.device_status)$interval.cancel(promise)}},4e3);this.devicePromiseList.push({id:question.id,promise:promise})}},setConsent:async function(consent){if(null==consent.consent_id){await CnHttpFactory.instance({path:"consent",data:{participant_id:this.data.participant_id,consent_type_id:consent.consent_type_id,accept:consent.accept,written:false,datetime:moment().format(),note:'Added by Pine during "'+this.data.qnaire_name+'" interview with token "'+$state.params.token+'".'}}).post()}else{await CnHttpFactory.instance({path:"consent/"+consent.consent_id,data:{accept:consent.accept}}).patch()}},checkToken:function(){if(this.data.scanned_token&&this.data.token_regex){try{const re=new RegExp(this.data.token_regex);if(!re.test(this.data.scanned_token)){CnModalMessageFactory.instance({title:"Invalid Token Format",message:'The token you have provided, "'+this.data.scanned_token+'", does not match the correct format.  Please check that you have entered it correctly.',error:true}).show();this.data.scanned_token=null}}catch(err){if(this.data.debug){CnModalMessageFactory.instance({title:"Invalid Token Regex",message:"WARNING: The questionnaire's token regex, \""+this.data.token_regex+'", is not a valid regular expression so it will be ignored.',error:true}).show()}}}},reopen:async function(){await CnHttpFactory.instance({path:"respondent/token="+$state.params.token+"?action=reopen"}).patch();await this.parentModel.reloadState(true)},setCheckIn:async function(checkedIn){var updatedToken=null;if(this.data.token_check&&checkedIn&&this.data.token!=this.data.scanned_token){var self=this;await CnHttpFactory.instance({path:"respondent/token="+$state.params.token,data:{token:this.data.scanned_token},onError:function(error){if(409==error.status){CnModalMessageFactory.instance({title:"Interview ID already exists",message:'You cannot use the Interview ID "'+self.data.scanned_token+'" since it already exists.  '+"Please double check that you have entered it correctly or try a different ID.",error:true}).show()}else CnModalMessageFactory.httpError(error)}}).patch();updatedToken=this.data.scanned_token}await CnHttpFactory.instance({path:"response/"+this.data.response_id,data:{checked_in:checkedIn}}).patch();if(null==updatedToken){await this.parentModel.reloadState(true)}else{await $state.go("respondent.run",{token:updatedToken})}},downloadReport:async function(){await CnHttpFactory.instance({path:["response",this.data.response_id].join("/"),format:"pdf"}).file()},text:function(address){return CnTranslationHelper.translate(address,this.currentLanguage)},checkForIncompleteQuestions:function(){return this.getVisibleQuestionList().some(question=>question.incomplete)},getVisibleQuestionList:function(){return this.questionList.filter(question=>this.evaluate(question.precondition))},getVisibleOptionList:function(question){return angular.isDefined(question.optionList)?question.optionList.filter(option=>this.evaluate(option.precondition)):[]},getFocusableQuestionList:function(){return this.getVisibleQuestionList().filter(question=>"comment"!=question.type)},getHotKey:function(question,item){var key=null;if(this.focusQuestionId==question.id){if("boolean"==question.type){if("dkna"==item){key=3}else if("refuse"==item){key=question.dkna_allowed?4:3}else{var bool=item;key=bool?1:2}}else if("list"==question.type){var optionList=this.getVisibleOptionList(question);if("dkna"==item){key=optionList.length+1}else if("refuse"==item){key=optionList.length+(question.dkna_allowed?1:0)+1}else{var optionId=item;var index=optionList.findIndexByProperty("id",optionId);if(null!=index)key=index+1}}else{if("dkna"==item){key=2}else if("refuse"==item){key=(question.dkna_allowed?1:0)+2}else{key=1}}if(this.upperDigitsActivated)key-=10;key=10==key?0:1<=key&&key<=9?key:null}return null==key?"":"["+key+"]"},isReportAvailable:function(){return null!=this.qnaireReportList&&this.qnaireReportList.includes(this.currentLanguage)},reportProblem:async function(){var response=await CnModalTextFactory.instance({title:this.text("misc.reportProblem.promptTitle"),message:this.data.problemPromptList[this.currentLanguage],html:true,size:"lg",minLength:1}).show();if(false!==response){var modal=CnModalMessageFactory.instance({title:this.text("misc.reportProblem.waitTitle"),message:this.text("misc.reportProblem.waitMessage"),block:true});modal.show();try{await CnHttpFactory.instance({path:["response",this.data.response_id,"problem_report"].join("/"),data:{description:response}}).post();CnModalMessageFactory.instance({title:this.text("misc.reportProblem.promptTitle"),message:this.data.problemConfirmList[this.currentLanguage],html:true}).show()}finally{modal.close()}}},getModulePrompt:function(){return null!=this.parentModel.viewModel.record.module_prompts?$sce.trustAsHtml(this.parentModel.viewModel.record.module_prompts[this.currentLanguage]):""},getModulePopup:function(){return null!=this.parentModel.viewModel.record.module_popups?this.parentModel.viewModel.record.module_popups[this.currentLanguage]:""},getPagePrompt:function(){return null!=this.parentModel.viewModel.record.prompts&&null!=this.parentModel.viewModel.record.popups?$sce.trustAsHtml((this.parentModel.viewModel.record.popups[this.currentLanguage]?'<b class="invert">ⓘ</b> ':"")+this.parentModel.viewModel.record.prompts[this.currentLanguage]):""},getPagePopup:function(){return null!=this.parentModel.viewModel.record.popups?this.parentModel.viewModel.record.popups[this.currentLanguage]:""},getQuestionPrompt:function(question){return $sce.trustAsHtml((question.popups[this.currentLanguage]||question.minimum||question.maximum?'<b class="invert">ⓘ</b> ':"")+question.prompts[this.currentLanguage])},getQuestionPopup:function(question){return question.popups[this.currentLanguage]+((question.minimum||question.maximum?" [":"")+(question.minimum?"Min: "+this.evaluateLimit(question.minimum):"")+(question.minimum&&question.maximum?", ":"")+(question.maximum?"Max: "+this.evaluateLimit(question.maximum):"")+(question.minimum||question.maximum?"]":""))},getOptionPrompt:function(question,option){return $sce.trustAsHtml(this.getHotKey(question,option.id)+(option.multiple_answers?"":' <i class="glyphicon '+(angular.isDefined(question.answer)&&question.answer.optionList[option.id].selected?"glyphicon-check":"glyphicon-unchecked")+'"></i> ')+(option.popups[this.currentLanguage]||null!=option.minimum||null!=option.maximum?'<b class="invert">ⓘ</b> ':"")+option.prompts[this.currentLanguage]+(option.multiple_answers?'<i class="glyphicon glyphicon-plus"></i>':""))},getOptionPopup:function(option){return option.popups[this.currentLanguage]+((option.minimum||option.maximum?" [":"")+(option.minimum?"Min: "+this.evaluateLimit(option.minimum):"")+(option.minimum&&option.maximum?", ":"")+(option.maximum?"Max: "+this.evaluateLimit(option.maximum):"")+(option.minimum||option.maximum?"]":""))},getLookupValues:async function(question,viewValue){question.isLoading=true;let retVal=undefined;try{const response=await CnHttpFactory.instance({path:["lookup",question.lookup.id,"lookup_item"].join("/"),data:{select:{column:["identifier",{column:"CONCAT( lookup_item.identifier, ': ', lookup_item.description )",alias:"description",table_prefix:false}]},modifier:{where:[{column:"lookup_item.identifier",operator:"like",value:"%"+viewValue+"%"},{column:"lookup_item.description",operator:"like",value:"%"+viewValue+"%",or:true}],order:{identifier:true}}}}).get();retVal=response.data}finally{question.isLoading=false}return retVal},getEquipmentValues:async function(question,viewValue){question.isLoading=true;let retVal=undefined;try{const response=await CnHttpFactory.instance({path:["equipment_type",question.equipment_type.id,"equipment"].join("/"),data:{select:{column:"serial_number"},modifier:{where:[{column:"equipment.active",operator:"=",value:true},{column:"equipment.site_id",operator:"=",value:CnSession.site.id},{column:"equipment.serial_number",operator:"like",value:"%"+viewValue+"%"}],order:"serial_number"}}}).get();retVal=response.data.reduce((list,item)=>{list.push(item.serial_number);return list},[])}finally{question.isLoading=false}return retVal},onReady:async function(){this.previewMode="respondent"!=parentModel.getSubjectFromState();this.showHidden=this.previewMode?true:angular.isDefined($state.params.show_hidden)?$state.params.show_hidden:false;this.alternateId=angular.isDefined($state.params.alternate_id)?$state.params.alternate_id:null;this.site=angular.isDefined($state.params.site)?$state.params.site:null;this.username=angular.isDefined($state.params.username)?$state.params.username:null;if(!this.previewMode){angular.extend(this,{responseStageList:null,consentList:null,deviationTypeList:null});var params="?assert_response=1";if(this.showHidden)params+="&show_hidden=1";var response=await CnHttpFactory.instance({path:"respondent/token="+$state.params.token+params,data:{select:{column:["token","participant_id","qnaire_id","start_datetime","end_datetime","introduction_list","conclusion_list","closed_list","problem_prompt_list","problem_confirm_list","phone_list",{table:"participant",column:"first_name"},{table:"participant",column:"last_name"},{table:"qnaire",column:"debug"},{table:"qnaire",column:"problem_report"},{table:"qnaire",column:"stages"},{table:"qnaire",column:"closed"},{table:"qnaire",column:"name",alias:"qnaire_name"},{table:"qnaire",column:"token_regex"},{table:"qnaire",column:"token_check"},{table:"response",column:"id",alias:"response_id"},{table:"response",column:"checked_in"},{table:"response",column:"page_id"},{table:"response",column:"stage_selection"},{table:"response",column:"submitted"},{table:"response",column:"comments"},{table:"response_stage",column:"id",alias:"response_stage_id"},{table:"response_stage",column:"stage_id"},{table:"language",column:"code",alias:"base_language"}]}},onError:function(error){$state.go("error."+error.status,error)}}).get();this.data=response.data;this.data.scanned_token=null==this.data.token.match(/^[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}$/)?this.data.token:null;if(this.data.stages){var[responseStageResponse,consentResponse,deviationTypeResponse,qnaireReportResponse,participantResponse,addressResponse]=await Promise.all([CnHttpFactory.instance({path:["response",this.data.response_id,"response_stage"].join("/"),data:{select:{column:["id","status","start_datetime","end_datetime","deviation_type_id","deviation_comments","comments",{table:"stage",column:"rank"},{table:"stage",column:"name"},{table:"deviation_type",column:"name",alias:"deviation"}]},modifier:{order:"stage.rank"}}}).query(),CnHttpFactory.instance({path:["respondent","token="+$state.params.token,"consent"].join("/"),data:{select:{column:[{table:"consent",column:"id",alias:"consent_id"},{table:"consent",column:"accept"},{table:"consent_type",column:"id",alias:"consent_type_id"},{table:"consent_type",column:"name",alias:"consent_type"},{table:"role_has_consent_type",column:"consent_type_id",alias:"access"}]}}}).query(),CnHttpFactory.instance({path:["qnaire",this.data.qnaire_id,"deviation_type"].join("/"),data:{modifier:{order:"deviation_type.name"}}}).query(),CnHttpFactory.instance({path:["qnaire",this.data.qnaire_id,"qnaire_report"].join("/"),data:{select:{column:[{table:"language",column:"code",alias:"lang"}]}}}).query(),this.participantModel.viewModel.onView(true),this.addressModel.viewModel.onView(true)]);this.responseStageList=responseStageResponse.data;if(0==this.responseStageList.length){throw new Error("Questionnaire has not stages, unable to proceed.")}this.responseStageList.forEach(responseStage=>{responseStage.operations=[];if(!["not ready","not applicable","parent skipped","skipped"].includes(responseStage.status)){var self=this;responseStage.operations.push({name:"launch",title:"completed"==responseStage.status?"Re-Open":"paused"==responseStage.status?"Resume":"Launch",getDeviation:function(){return self.responseStageList.filter(rs=>rs.rank<responseStage.rank).some(rs=>["ready","paused"].includes(rs.status))?"order":null}})}if(["paused","ready"].includes(responseStage.status)&&responseStage.rank!=this.responseStageList.length){responseStage.operations.push({name:"skip",title:"Skip",getDeviation:function(){return"skip"}})}if(!["not ready","not applicable","parent skipped","ready"].includes(responseStage.status)){responseStage.operations.push({name:"reset",title:"Reset",getDeviation:function(){return null}})}});this.consentList=consentResponse.data;this.consentList.forEach(consent=>consent.access=null!=consent.access);this.deviationTypeList=deviationTypeResponse.data;this.qnaireReportList=qnaireReportResponse.data.map(qnaireReport=>qnaireReport.lang);this.deviationTypeList.forEach(deviationType=>{deviationType.value=deviationType.id});this.participantInputList=[{key:"honorific",title:"Honorific",type:"string",help:"English examples: Mr. Mrs. Miss Ms. Dr. Prof. Br. Sr. Fr. Rev. Pr. "+"French examples: M. Mme Dr Dre Prof. F. Sr P. Révérend Pasteur Pasteure Me"},{key:"first_name",title:"First Name",type:"string"},{key:"other_name",title:"Other/Nickname",type:"string"},{key:"last_name",title:"Last Name",type:"string"},{key:"date_of_birth",title:"Date of Birth",type:"dob",isConstant:true,max:"now"},{key:"sex",title:"Sex at Birth",type:"enum",isConstant:true,enumList:this.participantModel.metadata.columnList.sex.enumList},{key:"current_sex",title:"Current Sex",type:"enum",enumList:this.participantModel.metadata.columnList.current_sex.enumList},{key:"email",title:"Email",type:"string",format:"email",help:"Must be in the format &quot;account@domain.name&quot;."}];this.addressInputList=[{key:"address1",title:"Address Line 1",type:"string",isConstant:true},{key:"address2",title:"Address Line 2",type:"string",isConstant:true},{key:"city",title:"City",type:"string",isConstant:true},{key:"region_id",title:"Region",type:"enum",isConstant:true,enumList:this.addressModel.metadata.columnList.region_id.enumList,help:"The region cannot be changed directly, instead it is automatically "+"updated based on the postcode."},{key:"postcode",title:"Postcode",type:"string",isConstant:true}]}angular.extend(this.data,{introductionList:CnTranslationHelper.parseDescriptions(this.data.introduction_list,this.showHidden),conclusionList:CnTranslationHelper.parseDescriptions(this.data.conclusion_list,this.showHidden),closedList:CnTranslationHelper.parseDescriptions(this.data.closed_list,this.showHidden),problemPromptList:CnTranslationHelper.parseDescriptions(this.data.problem_prompt_list,this.showHidden),problemConfirmList:CnTranslationHelper.parseDescriptions(this.data.problem_confirm_list,this.showHidden),phoneList:this.data.phone_list.split("`").map(item=>{const parts=item.split(":");return{type:parts[0],number:parts[1]}})});for(const lang in this.data.problemPromptList){if(0==this.data.problemPromptList[lang].length){this.data.problemPromptList[lang]=CnTranslationHelper.translate("misc.reportProblem.promptMessage",lang)}}for(const lang in this.data.problemConfirmList){if(0==this.data.problemConfirmList[lang].length){this.data.problemConfirmList[lang]=CnTranslationHelper.translate("misc.reportProblem.submitted",lang)}}}if(this.previewMode||null!=this.data.page_id){this.reset();await this.parentModel.viewModel.onView(true);angular.extend(this.data,{page_id:this.parentModel.viewModel.record.id,qnaire_id:this.parentModel.viewModel.record.qnaire_id,qnaire_name:this.parentModel.viewModel.record.qnaire_name,base_language:this.parentModel.viewModel.record.base_language,respondent_name:this.parentModel.viewModel.record.respondent_name});this.progress=Math.round(100*(angular.isDefined(this.parentModel.viewModel.record.stage_pages)?this.parentModel.viewModel.record.stage_page/this.parentModel.viewModel.record.stage_pages:this.parentModel.viewModel.record.qnaire_page/this.parentModel.viewModel.record.total_pages));const[questionResponse,languageResponse]=await Promise.all([CnHttpFactory.instance({path:this.parentModel.getServiceResourceBasePath()+"/question",data:{select:{column:["id","rank","name","type","mandatory","dkna_allowed","refuse_allowed","unit_list","minimum","maximum","default_answer","precondition","prompts","popups","device_id",{table:"device",column:"name",alias:"device"},"equipment_type_id",{table:"equipment_type",column:"name",alias:"equipment_type"},"lookup_id",{table:"lookup",column:"name",alias:"lookup"}]},modifier:{order:"question.rank"}}}).query(),await CnHttpFactory.instance({path:["qnaire",this.data.qnaire_id,"language"].join("/"),data:{select:{column:["id","code","name"]}}}).query()]);if(null==this.currentLanguage)this.currentLanguage=this.data.base_language;this.languageList=languageResponse.data;this.questionList=questionResponse.data;if(0<this.questionList.length&&angular.isDefined(this.questionList[0].language)){this.questionList.some(question=>{if(null!=question.language){this.currentLanguage=question.language;return true}});cenozoApp.setLang(this.currentLanguage)}if(this.parentModel.viewModel.record.debug){var column=["id","rank","name"];var modifier={order:"module.rank"};if(this.data.stages)modifier.where={column:"stage.id",operator:"=",value:this.data.stage_id};var response=await CnHttpFactory.instance({path:["qnaire",this.parentModel.viewModel.record.qnaire_id,"module"].join("/"),data:{select:{column:["id","rank","name"]},modifier:modifier}}).query();var foundCurrentModule=false;response.data.forEach(module=>{if(!foundCurrentModule&&module.id==this.parentModel.viewModel.record.module_id){foundCurrentModule=true}else{if(foundCurrentModule)this.nextModuleList.push(module);else this.prevModuleList.push(module)}})}var activeAttributeList=[];await Promise.all(this.questionList.reduce((list,question,questionIndex)=>{question.incomplete=false;question.value=angular.fromJson(question.value);question.backupValue=angular.copy(question.value);activeAttributeList=activeAttributeList.concat(getAttributeNames(question.precondition));if("list"==question.type){list.push((async()=>{var response=await CnHttpFactory.instance({path:["question",question.id,"question_option"].join("/")+(!this.previewMode?"?token="+$state.params.token:""),data:{select:{column:["id","question_id","name","exclusive","extra","multiple_answers","unit_list","minimum","maximum","precondition","prompts","popups"]},modifier:{order:"question_option.rank"}}}).query();question.optionList=response.data;question.optionList.forEach(option=>{activeAttributeList=activeAttributeList.concat(getAttributeNames(option.precondition));option.rawPrompts=option.prompts;option.prompts=CnTranslationHelper.parseDescriptions(this.evaluateDescription(option.rawPrompts));option.rawPopups=option.popups;option.popups=CnTranslationHelper.parseDescriptions(this.evaluateDescription(option.rawPopups));this.optionListById[option.id]=option;if("number with unit"==option.extra){option.unitListEnum=getUnitListEnum(option.unit_list,this.languageList,this.parentModel.viewModel.record.base_language)}})})())}else if("audio"==question.type){question.audio=CnAudioRecordingFactory.instance({timeLimit:0<question.maximum?1e3*question.maximum:6e4,onComplete:blob=>{question.file=blob;question.objectURL=window.URL.createObjectURL(question.file);this.setAnswer(question,{filesize:question.file.size})},onTimeout:()=>{const beep=new Audio(cenozoApp.baseUrl+"/img/beep.mp3");beep.play();CnModalMessageFactory.instance({title:this.text("misc.maxRecordingTimeTitle"),message:this.text("misc.maxRecordingTimeMessage")}).show()}});question.objectURL=null;if(null!=question.file){question.file=cenozo.convertBase64ToBlob(question.file,"audio/wav");question.objectURL=window.URL.createObjectURL(question.file)}}else if("equipment"==question.type){question.equipment_type={id:question.equipment_type_id,name:question.equipment_type,isLoading:false};delete question.equipment_type_id}else if("lookup"==question.type){question.lookup={id:question.lookup_id,name:question.lookup,isLoading:false};delete question.lookup_id}else if("number with unit"==question.type){question.unitListEnum=getUnitListEnum(question.unit_list,this.languageList,this.parentModel.viewModel.record.base_language)}return list},[]));this.questionList.forEach(question=>{question.rawPrompts=question.prompts;question.prompts=CnTranslationHelper.parseDescriptions(this.evaluateDescription(question.rawPrompts));question.rawPopups=question.popups;question.popups=CnTranslationHelper.parseDescriptions(this.evaluateDescription(question.rawPopups));this.convertValueToModel(question);if("audio"==question.type){question.maximumAsTime=question.maximum?moment.utc(question.maximum*1e3).format("mm:ss"):null}this.addDevicePromise(question)});this.activeAttributeList=activeAttributeList.sort().filter((attribute,index,array)=>index===array.indexOf(attribute)).map(attribute=>({name:attribute,value:null}))}else{if(!this.data.stage_selection&&null==this.data.page_id)await this.reset();var response=await CnHttpFactory.instance({path:["qnaire",this.data.qnaire_id,"language"].join("/"),data:{select:{column:["id","code","name"]}}}).query();this.languageList=response.data;if(null==this.currentLanguage)this.currentLanguage=this.data.base_language}this.data.title=this.data.submitted?"Conclusion":null!=this.data.page_id?"":this.data.stage_selection?["Interview",$state.params.token,this.data.checked_in?"Stage Selection":"Check-In"].join(" "):"Introduction"},runQuery:async fn=>{await Promise.all(this.writePromiseList);var response=null;var newIndex=this.promiseIndex++;try{response=fn();response.index=newIndex}finally{var index=this.writePromiseList.findIndexByProperty("index",newIndex);if(null!=index)this.writePromiseList.splice(index,1)}await response},convertValueToModel:function(question){question.variable_name=question.name+(this.parentModel.viewModel.record.variable_suffix?"_"+this.parentModel.viewModel.record.variable_suffix:"");if("boolean"==question.type){question.answer={yes:true===question.value,no:false===question.value}}else if("list"==question.type){var selectedOptions=angular.isArray(question.value)?question.value:[];question.answer={optionList:question.optionList.reduce((list,option)=>{var optionIndex=searchOptionList(selectedOptions,option.id);list[option.id]=option.multiple_answers?{valueList:[],formattedValueList:[]}:{selected:null!=optionIndex};if(option.extra){if(null!=optionIndex){let value=selectedOptions[optionIndex].value;if("number with unit"==option.extra){if(!angular.isObject(value))value={value:null,unit:null}}list[option.id].valueList=option.multiple_answers?value:[value];list[option.id].formattedValueList=null;if("date"==option.extra){list[option.id].formattedValueList=option.multiple_answers?formatDate(selectedOptions[optionIndex].value):[formatDate(selectedOptions[optionIndex].value)]}else if("time"==option.extra){list[option.id].formattedValueList=option.multiple_answers?formatTime(selectedOptions[optionIndex].value):[formatTime(selectedOptions[optionIndex].value)]}}else{list[option.id].valueList=option.multiple_answers?[]:[null];list[option.id].formattedValueList=option.multiple_answers?[]:[null]}}return list},{})}}else if("number with unit"==question.type){question.answer=angular.isObject(question.value)?question.value:{value:null,unit:null}}else if("equipment"==question.type){if(angular.isObject(question.value)){question.answer={value:question.value.serial_number}}else if(angular.isString(question.value)){question.answer={value:question.value}}else{question.answer={value:null}}}else if("lookup"==question.type){if(angular.isObject(question.value)){question.answer={value:question.value.identifier,formattedValue:question.value.description}}else if(angular.isString(question.value)){question.answer={value:question.value,formattedValue:question.value};async function setFormattedValue(question){const response=await CnHttpFactory.instance({path:"lookup_item/lookup_id="+question.lookup.id+";identifier="+question.value}).get();question.answer.formattedValue=response.data.identifier+": "+response.data.description;question.answer.backupFormattedValue=question.answer.formattedValue}setFormattedValue(question)}else{question.answer={value:null,formattedValue:null}}question.answer.backupFormattedValue=question.answer.formattedValue}else{question.answer={value:angular.isString(question.value)||angular.isNumber(question.value)?question.value:null,formattedValue:null};if("date"==question.type){question.answer.formattedValue=formatDate(question.value)}else if("time"==question.type){question.answer.formattedValue=formatTime(question.value)}if("device"==question.type){if(isDkna(question.value)||isRefuse(question.value)){question.device_status=null;question.device_uuid=null}}}question.answer.dkna=isDkna(question.value);question.answer.refuse=isRefuse(question.value)},questionIsComplete:function(question){if("comment"==question.type)return true;if(!this.evaluate(question.precondition))return true;if(null==question.value)return false;if(isDknaOrRefuse(question.value))return true;if("list"==question.type){var preconditionListById=question.optionList.reduce((object,option)=>{object[option.id]=option.precondition;return object},{});for(var index=0;index<question.value.length;index++){var selectedOption=question.value[index];var selectedOptionId=angular.isObject(selectedOption)?selectedOption.id:selectedOption;if(angular.isObject(selectedOption)){const extra=question.optionList.findByProperty("id",selectedOptionId).extra;if("number with unit"==extra){if(!angular.isObject(selectedOption.value)||angular.isUndefined(selectedOption.value.value)||null==selectedOption.value.value||angular.isUndefined(selectedOption.value.unit)||null==selectedOption.value.unit)return selectedOption.id}else if(null==selectedOption.value){return selectedOption.id}else if(angular.isArray(selectedOption.value)){if(0==selectedOption.value.filter(v=>null!=v).length)return false}}}for(var index=0;index<question.value.length;index++){var selectedOption=question.value[index];var selectedOptionId=angular.isObject(selectedOption)?selectedOption.id:selectedOption;if(this.evaluate(preconditionListById[selectedOptionId])){if(angular.isObject(selectedOption)){if(angular.isArray(selectedOption.value)){for(var valueIndex=0;valueIndex<selectedOption.value.length;valueIndex++){if(null!=selectedOption.value[valueIndex]){return true}}}else if(null!=selectedOption.value)return true}else if(null!=selectedOption)return true}}return false}else if("number with unit"==question.type){return angular.isObject(question.value)&&angular.isDefined(question.value.value)&&null!=question.value.value&&angular.isDefined(question.value.unit)&&null!=question.value.unit}else if("device"==question.type){return"completed"==question.device_status}return true},evaluateAllDescriptions:function(){this.questionList.filter(q=>this.evaluate(q.precondition)).forEach(q=>{q.prompts=CnTranslationHelper.parseDescriptions(this.evaluateDescription(q.rawPrompts));q.popups=CnTranslationHelper.parseDescriptions(this.evaluateDescription(q.rawPopups));if("list"==q.type){q.optionList.forEach(o=>{o.prompts=CnTranslationHelper.parseDescriptions(this.evaluateDescription(o.rawPrompts));o.popups=CnTranslationHelper.parseDescriptions(this.evaluateDescription(o.rawPopups))})}if("list"==q.type){q.optionList.forEach(o=>{o.prompts=CnTranslationHelper.parseDescriptions(this.evaluateDescription(o.rawPrompts));o.popups=CnTranslationHelper.parseDescriptions(this.evaluateDescription(o.rawPopups))})}})},evaluateDescription:function(description){return this.evaluate(description,"description")},evaluateLimit:function(limit){return this.evaluate(limit,"limit")},evaluate:function(expression,type){if(angular.isUndefined(type))type="precondition";if(null==expression)return"precondition"==type?true:"limit"==type?null:"";if("limit"==type){expression=expression.replace(/\bcurrent_year\b/,moment().format("YYYY"));expression=expression.replace(/\bcurrent_month\b/,moment().format("MM"));expression=expression.replace(/\bcurrent_day\b/,moment().format("DD"))}if("precondition"==type&&true==expression||false==expression)return expression;if(this.previewMode){this.activeAttributeList.forEach(attribute=>{var qualifier="showhidden"==attribute.name?"\\b":"@";var re=new RegExp(qualifier+attribute.name+qualifier);var value=attribute.value;if(null==value){}else if(""==value){value=null}else if("true"==value){value=true}else if("false"==value){value=false}else{var num=parseFloat(value);if(num==value)value=num;else value='"'+value+'"'}expression=expression.replace(re,value)});expression=expression.replace(/@[^@ ]+@/g,"precondition"==type?"null":"limit"==type?null:"")}var matches=expression.match(/\$[^$ ]+\$/g);if(null!=matches)matches.forEach(match=>{var parts=match.slice(1,-1).toLowerCase().split(".");var fnName=1<parts.length?parts[1]:null;var subparts=parts[0].toLowerCase().split(":");var questionName=subparts[0];var optionName=null;var pathName=null;if(1<subparts.length){if("count()"==subparts[1])fnName="count()";else optionName=subparts[1]}else if(null!=fnName){if("extra("==fnName.substr(0,6)){optionName=fnName.match(/extra\(([^)]+)\)/)[1];fnName="extra()"}else if("value("==fnName.substr(0,6)){pathName=match.match(/value\("([^"]+)"\)/)[1];fnName="value()"}}var matchedQuestion=null;this.questionList.some(q=>{if(questionName==q.name.toLowerCase()){matchedQuestion=q;return true}});var compiled="null";if(null!=matchedQuestion){if("empty()"==fnName){compiled=null==matchedQuestion.value?"true":"false"}else if("not_empty()"==fnName){compiled=null==matchedQuestion.value?"false":"true"}else if("dkna()"==fnName){compiled=isDkna(matchedQuestion.value)?"true":"false"}else if("refuse()"==fnName){compiled=isRefuse(matchedQuestion.value)?"true":"false"}else if("dkna_refuse()"==fnName){compiled=isDkna(matchedQuestion.value)||isRefuse(matchedQuestion.value)?"true":"false"}else if("not_dkna_refuse()"==fnName){compiled=isDkna(matchedQuestion.value)||isRefuse(matchedQuestion.value)?"false":"true"}else if("dkna_refuse_empty()"==fnName){compiled=isDkna(matchedQuestion.value)||isRefuse(matchedQuestion.value)||null==matchedQuestion.value?"true":"false"}else if("not_dkna_refuse_empty()"==fnName){compiled=isDkna(matchedQuestion.value)||isRefuse(matchedQuestion.value)||null==matchedQuestion.value?"false":"true"}else if("count()"==fnName){compiled=angular.isArray(matchedQuestion.value)?matchedQuestion.value.length:0}else if("boolean"==matchedQuestion.type){if(true===matchedQuestion.value)compiled="true";else if(false===matchedQuestion.value)compiled="false"}else if("number"==matchedQuestion.type){if(angular.isNumber(matchedQuestion.value))compiled=matchedQuestion.value}else if("date"==matchedQuestion.type){if(angular.isString(matchedQuestion.value))compiled=matchedQuestion.value}else if("string"==matchedQuestion.type){if(angular.isString(matchedQuestion.value))compiled="'"+matchedQuestion.value.replace(/'/g,"\\'")+"'"}else if("device"==matchedQuestion.type){if(pathName){if(angular.isObject(matchedQuestion.value)){compiled=jsonpath.query(matchedQuestion.value,"$."+pathName)}}}else if("list"==matchedQuestion.type){if(null==optionName){compiled=angular.isObject(matchedQuestion.value)&&angular.isDefined(matchedQuestion.value.refuse)?this.text("misc.refuse"):angular.isObject(matchedQuestion.value)&&angular.isDefined(matchedQuestion.value.dkna)?this.text("misc.dkna"):angular.isArray(matchedQuestion.value)?matchedQuestion.value.map(option=>matchedQuestion.optionList.findByProperty("id",angular.isObject(option)?option.id:option).prompts[this.currentLanguage]+(angular.isObject(option)?" "+option.value:"")).join(", "):""}else{var matchedOption=null;if(angular.isArray(matchedQuestion.optionList)){matchedQuestion.optionList.some(o=>{if(optionName==o.name.toLowerCase()){matchedOption=o;return true}})}if(null!=matchedOption&&angular.isArray(matchedQuestion.value)){if(null==matchedOption.extra){compiled=matchedQuestion.value.includes(matchedOption.id)?"true":"false"}else{var answer=matchedQuestion.value.findByProperty("id",matchedOption.id);if(!angular.isObject(answer)){compiled="extra()"==fnName?"null":"false"}else{if("extra()"==fnName){var value=angular.isArray(answer.value)?answer.value.filter(a=>null!=a).join(", "):answer.value;compiled="number"==matchedOption.extra?value:'"'+value.replace('"','"')+'"'}else if(matchedOption.multiple_answers){compiled=answer.value.some(v=>v!=null)?"true":"false"}else if("extra()"==fnName){compiled="number"==matchedOption.extra?answer.value:'"'+answer.value.replace('"','"')+'"'}else{compiled=null!=answer.value?"true":"false"}}}}}}}expression=expression.replace(match,compiled)});if("precondition"!=type)return expression;function evaluateExpression(precondition){return Function('"use strict"; return '+precondition+";")()}return evaluateExpression(expression)},setLanguage:async function(){cenozoApp.setLang(this.currentLanguage);if(!this.previewMode&&null!=this.currentLanguage){await this.runQuery(async()=>{await CnHttpFactory.instance({path:this.parentModel.getServiceResourceBasePath().replace("page/","respondent/")+"?action=set_language&code="+this.currentLanguage}).patch()})}},startRecording:async function(question){var proceed=true;if(question.answer.formattedValue){var response=await CnModalConfirmFactory.instance({title:this.text("misc.pleaseConfirm"),message:this.text("misc.reRecordConfirm")}).show();proceed=response}if(proceed)await question.audio.start()},stopRecording:async function(question){question.audio.stop()},getDevicePrompt:function(question){let prompt=this.text("misc.launch")+" "+question.device;if("in progress"==question.device_status){prompt=this.text("misc.abort")+" "+question.device}else if("completed"==question.device_status){prompt=this.text("misc.reLaunch")+" "+question.device+" (";const dataReceived=!isDkna(question.value)&&!isRefuse(question.value)&&null!=question.value;const filesReceived=angular.isDefined(question.files_received)?question.files_received:0;if(dataReceived&&0<filesReceived){prompt+=this.text("misc.dataAndFileReceived").replaceAll("<FILES>",filesReceived).replaceAll("<PLURAL>",1==filesReceived?"":"s")}else if(dataReceived&&0==filesReceived){prompt+=this.text("misc.dataReceived")}else if(!dataReceived&&0<filesReceived){prompt+=this.text("misc.fileReceived").replaceAll("<FILES>",filesReceived).replaceAll("<PLURAL>",1==filesReceived?"":"s")}else{prompt+=this.text("misc.noDataReceived")}prompt+=")"}return prompt},launchDevice:async function(question){try{this.working=true;var modal=CnModalMessageFactory.instance({title:this.text("misc.deviceWaitTitle"),message:this.text("misc.deviceWaitMessage"),block:true});modal.show();var response=await CnHttpFactory.instance({path:"answer/"+question.answer_id+"?action=launch_device"}).patch();question.device_status=response.data.status;question.device_uuid=response.data.uuid;question.value=null;this.addDevicePromise(question)}finally{this.convertValueToModel(question);this.evaluateAllDescriptions();modal.close();this.working=false}},abortDevice:async function(question){try{this.working=true;var response=await CnHttpFactory.instance({path:"answer_device/uuid="+question.device_uuid,data:{status:"cancelled"}}).patch();question.device_status=null;question.device_uuid=null;const promiseIndex=this.devicePromiseList.findIndexByProperty("id",question.id);if(null!=promiseIndex){$interval.cancel(this.devicePromiseList[promiseIndex].promise);this.devicePromiseList.splice(promiseIndex,1)}}finally{this.evaluateAllDescriptions();this.working=false}},typeaheadChanged:function(question){if(!this.setAnswerInProgress){if(null===question.answer.formattedValue){this.setAnswer(question,null)}else{question.answer.formattedValue=question.answer.backupFormattedValue}}},setAnswerInProgress:false,setAnswer:async function(question,value,noCompleteCheck){this.setAnswerInProgress=true;if(angular.isUndefined(noCompleteCheck))noCompleteCheck=false;const minimum=this.evaluateLimit(question.minimum);const maximum=this.evaluateLimit(question.maximum);const tooSmall=isTooSmall(question.type,minimum,value);const tooLarge=isTooLarge(question.type,maximum,value);if(tooSmall||tooLarge){await this.runQuery(async()=>{await CnModalMessageFactory.instance({title:this.text(tooSmall?"misc.minimumTitle":"misc.maximumTitle"),message:this.text("misc.limitMessage")+" "+(null==maximum?this.text("misc.equalOrGreater")+" "+minimum+".":null==minimum?this.text("misc.equalOrLess")+" "+maximum+".":[this.text("misc.between"),minimum,this.text("misc.and"),maximum+"."].join(" "))}).show();question.value=angular.copy(question.backupValue);this.convertValueToModel(question)})}else{await this.runQuery(async()=>{if("text"==question.type){if(angular.isString(value)){var ignore=null;if(isDkna(question.value))ignore="ignoreDkna";else if(isRefuse(question.value))ignore="ignoreRefuse";if(null!=ignore)question[ignore]=true;$timeout(()=>{if(null!=ignore)delete question[ignore]},500)}else if(question.ignoreDkna&&(null===value||isDkna(value))||question.ignoreRefuse&&(null===value||isRefuse(value))){this.convertValueToModel(question);return}}try{this.working=true;if(""===value)value=null;if(!this.previewMode){var self=this;if("audio"==question.type){if(!angular.isObject(value)||!angular.isDefined(value.filesize)){question.file="";question.objectURL=null}await CnHttpFactory.instance({path:"answer/"+question.answer_id+"?filename=audio.wav",data:question.file,format:"wav",onError:function(error){question.value=angular.copy(question.backupValue);self.convertValueToModel(question)}}).patch()}let path="answer/"+question.answer_id;let queryArray=[];if(this.site)queryArray.push("site="+encodeURIComponent(this.site));if(this.username)queryArray.push("username="+encodeURIComponent(this.username));if(0<queryArray.length)path+="?"+queryArray.join("&");let data={value:angular.toJson("lookup"==question.type&&null!=value&&angular.isObject(value)&&angular.isDefined(value.identifier)?value.identifier:value)};if(null!=this.alternateId)data.alternate_id=this.alternateId;await CnHttpFactory.instance({path:path,data:data,onError:function(error){question.value=angular.copy(question.backupValue);self.convertValueToModel(question)}}).patch()}question.value=value;question.backupValue=angular.copy(question.value);this.convertValueToModel(question);this.questionList.forEach(q=>{if(!this.evaluate(q.precondition)){if(null!=q.value){q.value=null;this.convertValueToModel(q)}}else{if(null!=q.default_answer&&null==q.value){q.value=q.default_answer;this.convertValueToModel(q)}if("list"==q.type&&!isDknaOrRefuse(q.value)){var visibleOptionList=this.getVisibleOptionList(q);q.optionList.forEach(o=>{if(null==visibleOptionList.findByProperty("id",o.id)){if(angular.isArray(q.value)){var i=searchOptionList(q.value,o.id);if(null!=i){q.value.splice(i,1);if(0==q.value.length)q.value=null;this.convertValueToModel(q)}}}})}}});this.evaluateAllDescriptions();if(!noCompleteCheck){var complete=this.questionIsComplete(question);question.incomplete=false===complete?true:true===complete?false:complete}}finally{this.working=false}})}this.setAnswerInProgress=false},getValueForNewOption:function(question,option){var data=option.extra?{id:option.id,value:option.multiple_answers?[]:null}:option.id;var value=[];if(option.exclusive){value.push(data)}else{if(angular.isArray(question.value))value=question.value;value=value.filter(o=>!this.optionListById[angular.isObject(o)?o.id:o].exclusive);if(null==searchOptionList(value,option.id))value.push(data);value.sort(function(a,b){return(angular.isObject(a)?a.id:a)-(angular.isObject(b)?b.id:b)})}return value},addOption:async function(question,option){await this.setAnswer(question,this.getValueForNewOption(question,option));if(null!=option.extra)await focusElement("option"+option.id+"value0")},removeOption:async function(question,option){var value=angular.isArray(question.value)?question.value:[];var optionIndex=searchOptionList(value,option.id);if(null!=optionIndex)value.splice(optionIndex,1);if(0==value.length)value=null;await this.setAnswer(question,value)},addAnswerValue:async function(question,option){var value=angular.isArray(question.value)?question.value:[];var optionIndex=searchOptionList(value,option.id);if(null==optionIndex){value=this.getValueForNewOption(question,option);optionIndex=searchOptionList(value,option.id)}var valueIndex=value[optionIndex].value.indexOf(null);if(-1==valueIndex)valueIndex=value[optionIndex].value.push(null)-1;await this.setAnswer(question,value,true);await focusElement("option"+option.id+"value"+valueIndex)},removeAnswerValue:async function(question,option,valueIndex){var value=question.value;var optionIndex=searchOptionList(value,option.id);value[optionIndex].value.splice(valueIndex,1);if(0==value[optionIndex].value.length)value.splice(optionIndex,1);if(0==value.length)value=null;await this.setAnswer(question,value)},selectDateOrTimeForQuestionOrOption:async function(question,option,valueIndex,value,type){if(!["date","time"].includes(type)){throw new Error('Invalid type "'+type+'", must be "date" or "time".')}try{this.hotKeyDisabled=true;const modalObj={title:null,locale:this.currentLanguage,date:"date"==type?value:getTime(null==value?"12:00":value,CnSession.user.timezone),pickerType:type,emptyAllowed:true};if("date"==type){angular.extend(modalObj,{minDate:getDate(this.evaluateLimit(null!=option?option.minimum:question.minimum)),maxDate:getDate(this.evaluateLimit(null!=option?option.maximum:question.maximum))})}var response=await CnModalDatetimeFactory.instance(modalObj).show();if(false!==response){if("time"==type&&null!=response){const match=response.match(/^([0-9]+):([0-9]+)$/);let m=moment();m.hour(parseInt(match[1]));m.minute(parseInt(match[2]));m.second(0);m.tz(CnSession.user.timezone);response=moment(m).format("HH:mm")}else if("date"==type&&null!=response){response=response.replace(/T.*/,"")}if(null!=option){await this.setAnswerValue(question,option,valueIndex,response)}else{await this.setAnswer(question,response)}}}finally{this.hotKeyDisabled=false}},selectDateForOption:async function(question,option,valueIndex,answerValue){this.selectDateOrTimeForQuestionOrOption(question,option,valueIndex,answerValue,"date")},selectDate:async function(question,value){this.selectDateOrTimeForQuestionOrOption(question,null,null,value,"date")},selectTimeForOption:async function(question,option,valueIndex,answerValue){this.selectDateOrTimeForQuestionOrOption(question,option,valueIndex,answerValue,"time")},selectTime:async function(question,value){this.selectDateOrTimeForQuestionOrOption(question,null,null,value,"time")},setAnswerValue:async function(question,option,valueIndex,answerValue){const minimum=this.evaluateLimit(option.minimum);const maximum=this.evaluateLimit(option.maximum);const tooSmall=isTooSmall(option.extra,minimum,answerValue);const tooLarge=isTooLarge(option.extra,maximum,answerValue);if(tooSmall||tooLarge){await this.runQuery(async()=>{await CnModalMessageFactory.instance({title:this.text(tooSmall?"misc.minimumTitle":"misc.maximumTitle"),message:this.text("misc.limitMessage")+" "+(null==maximum?this.text("misc.equalOrGreater")+" "+minimum+".":null==minimum?this.text("misc.equalOrLess")+" "+maximum+".":[this.text("misc.between"),minimum,this.text("misc.and"),maximum+"."].join(" "))}).show();var element=document.getElementById("option"+option.id+"value"+valueIndex);element.value=question.answer.optionList[option.id].valueList[valueIndex]})}else{var value=question.value;var optionIndex=searchOptionList(value,option.id);if(null!=optionIndex){if(option.multiple_answers){if(null==answerValue||angular.isString(answerValue)&&0==answerValue.trim().length){value[optionIndex].value.splice(valueIndex,1)}else{var existingValueIndex=value[optionIndex].value.indexOf(answerValue);if(0<=existingValueIndex){document.getElementById("option"+option.id+"value"+valueIndex).value=null;var element=document.getElementById("option"+option.id+"value"+existingValueIndex);element.focus();element.select()}else{value[optionIndex].value[valueIndex]=answerValue}}}else{value[optionIndex].value=""!==answerValue?answerValue:null;if("date"==option.extra){question.answer.optionList[option.id].formattedValueList[valueIndex]=formatDate(value[optionIndex].value)}else if("time"==option.extra){question.answer.optionList[option.id].formattedValueList[valueIndex]=formatTime(value[optionIndex].value)}else if("number with unit"){if(angular.isUndefined(value[optionIndex].value.value)){value[optionIndex].value.value=null}if(angular.isUndefined(value[optionIndex].value.unit)){value[optionIndex].value.unit=null}}}}await this.setAnswer(question,value)}},viewPage:async function(){await $state.go("page.view",{identifier:this.parentModel.viewModel.record.getIdentifier()},{reload:true})},showDisplayResponseButton:function(){return this.parentModel.isRole("interviewer","administrator")},transitionToDisplayResponse:function(){$state.go("response.display",{identifier:this.data.response_id})},setResponseComments:async function(){try{this.working=true;await this.runQuery(async()=>{await CnHttpFactory.instance({path:"response/"+this.data.response_id,data:{comments:this.data.comments}}).patch()})}finally{this.working=false}},showStageComments:async function(responseStageId){if(!responseStageId)responseStageId=this.data.response_stage_id;var responseStage=this.responseStageList.findByProperty("id",responseStageId);var response=await CnModalTextFactory.instance({title:responseStage.name+" Comments",message:"Please provide any relevant comments about this stage:",text:responseStage.comments,size:"lg"}).show();if(false!==response){try{this.working=true;await this.runQuery(async()=>{await CnHttpFactory.instance({path:"response_stage/"+responseStageId,data:{comments:response}}).patch();responseStage.comments=response})}finally{this.working=false}}},isStageOperationEnabled:function(responseStageId,operationName){var enabled=true;if(["skip","launch"].includes(operationName)){var deviation=this.responseStageList.findByProperty("id",responseStageId).operations.findByProperty("name",operationName).getDeviation();enabled=null==deviation||0<this.deviationTypeList.filter(dt=>deviation==dt.type).length}return enabled},runStageOperation:async function(responseStageId,operationName){if(!responseStageId)responseStageId=this.data.response_stage_id;var responseStage=this.responseStageList.findByProperty("id",responseStageId);if(!["launch","pause","skip","reset"].includes(operationName)){throw new Error('Tried to run invalid stage operation "'+operationName+'"')}var responseStageResponse=await CnHttpFactory.instance({path:"response_stage/"+responseStageId,data:{select:{column:["status","user_id",{table:"user",column:"first_name"},{table:"user",column:"last_name"}]}}}).get();var data=responseStageResponse.data;var warning=null;if(["not ready","not applicable","parent skipped"].includes(data.status)||"skipped"==data.status&&"reset"!=operationName||"ready"==data.status&&"reset"==operationName||"completed"==data.status&&"skip"==operationName){await CnModalMessageFactory.instance({title:"Please Note",message:"The interview has changed and must be reloaded before you can proceed. "+"Once you close this message the interview data will automatically be refreshed.",error:true}).show();await this.onReady();return}else if("active"==data.status){warning="<b>WARNING</b>: This stage is already active "+(data.user_id!=CnSession.user.id?"by another user ("+data.first_name+" "+data.last_name+")":"under your account.")}else if("paused"==data.status||"completed"==data.status&&"launch"==operationName){if(data.user_id!=CnSession.user.id){warning="<b>WARNING</b>: This stage was paused by another user ("+data.first_name+" "+data.last_name+")"}}var patchData=null;var proceed=true;if("reset"==operationName){var response=await CnModalConfirmFactory.instance({message:"Are you sure you wish to reset this stage?<br><br>"+'<b class="text-danger">Note that by proceeding all data '+"collected during the stage will be deleted."+(warning?"<br><br>"+warning:"")+"</b>",html:true}).show();proceed=response}else if(["skip","launch"].includes(operationName)){proceed=true;var deviation=responseStage.operations.findByProperty("name",operationName).getDeviation();if(deviation||this.data.token_check){proceed=false;var response=await CnModalPreStageFactory.instance({title:responseStage.name+": "+operationName.ucWords(),warning:warning,deviationTypeList:deviation?this.deviationTypeList.filter(dt=>deviation==dt.type):null,validToken:$state.params.token,token:this.data.token_check?null:$state.params.token,tokenReadOnly:!this.data.token_check,deviationTypeId:responseStage.deviation_type_id,deviationComments:responseStage.deviation_comments,comments:responseStage.comments}).show();if(null!=response){patchData=response;proceed=true}}}if(proceed){try{this.working=true;await this.runQuery(async()=>{var httpObj={path:"response_stage/"+responseStageId+"?action="+operationName};if(null!=patchData){httpObj.data=patchData;angular.extend(responseStage,patchData)}await CnHttpFactory.instance(httpObj).patch();await this.parentModel.reloadState(true)})}finally{this.working=false}}},proceed:async function(){const record=this.parentModel.viewModel.record;if(this.previewMode){await $state.go("page.render",{identifier:record.next_id},{reload:true})}else{var modal=CnModalMessageFactory.instance({title:this.text("misc.submitWaitTitle"),message:this.text("misc.submitWaitMessage"),block:true});try{this.working=true;var mayProceed=true;this.questionList.some(question=>{var complete=this.questionIsComplete(question);question.incomplete=false===complete?true:true===complete?false:complete;if(question.incomplete){mayProceed=false;return true}});if(mayProceed){await this.runQuery(async()=>{if(null===record.next_id)modal.show();let path="respondent/token="+$state.params.token+"?action=proceed";if(this.site)path+="&site="+encodeURIComponent(this.site);if(this.username)path+="&username="+encodeURIComponent(this.username);await CnHttpFactory.instance({path:path}).patch();await this.parentModel.reloadState(true)})}}finally{if(null===record.next_id)modal.close();this.working=false}}},backup:async function(){if(this.previewMode){await $state.go("page.render",{identifier:this.parentModel.viewModel.record.previous_id},{reload:true})}else{try{this.working=true;await this.runQuery(async()=>{await CnHttpFactory.instance({path:"respondent/token="+$state.params.token+"?action=backup"}).patch();await this.parentModel.reloadState(true)})}finally{this.working=false}}},jump:async function(moduleId){try{this.working=true;await this.runQuery(async()=>{await CnHttpFactory.instance({path:"respondent/token="+$state.params.token+"?action=jump&module_id="+moduleId}).patch();await this.parentModel.reloadState(true)})}finally{this.working=false}},fastForwardStage:async function(){try{this.working=true;await this.runQuery(async()=>{await CnHttpFactory.instance({path:"respondent/token="+$state.params.token+"?action=fast_forward_stage"}).patch();await this.parentModel.reloadState(true)})}finally{this.working=false}},rewindStage:async function(){try{this.working=true;await this.runQuery(async()=>{await CnHttpFactory.instance({path:"respondent/token="+$state.params.token+"?action=rewind_stage"}).patch();await this.parentModel.reloadState(true)})}finally{this.working=false}},onDigitHotKey:async function(digit){var question=this.questionList.findByProperty("id",this.focusQuestionId);if(null==question)return;var value=undefined;if("boolean"==question.type){if(1==digit){value=question.answer.yes?null:true}else if(2==digit){value=question.answer.no?null:false}else if(3==digit){value="dkna_refuse_1"}else if(4==digit){value="dkna_refuse_2"}}else if("list"==question.type){var optionList=this.getVisibleOptionList(question);if(digit<=optionList.length){value=optionList[digit-1]}else{if(digit==optionList.length+1){value="dkna_refuse_1"}else if(digit==optionList.length+2){value="dkna_refuse_2"}}}else{if(1==digit){if("date"==question.type){await this.selectDate(question,question.answer.value)}else if("time"==question.type){await this.selectTime(question,question.answer.value)}else{await focusElement("question"+question.id)}}else if(2==digit){value="dkna_refuse_1"}else if(3==digit){value="dkna_refuse_2"}}if(angular.isDefined(value)){var setAnswerTo=undefined;if(angular.isObject(value)){var option=value;if(option.multiple_answers){await this.addAnswerValue(question,option)}else if(question.answer.optionList[option.id].selected){await this.removeOption(question,option)}else{await this.addOption(question,option)}}else if(angular.isString(value)){var match=value.match(/^dkna_refuse_([0-9])/);if(match){if(1==match[1]){if(question.dkna_allowed){setAnswerTo=question.answer.dkna?null:{dkna:true}}else if(question.refuse_allowed){setAnswerTo=question.answer.refuse?null:{refuse:true}}}else if(2==match[1]){if(question.dkna_allowed&&question.refuse_allowed){setAnswerTo=question.answer.refuse?null:{refuse:true}}}}}else{setAnswerTo=value}if(angular.isDefined(setAnswerTo))await this.setAnswer(question,setAnswerTo)}},focusQuestion:function(prev){if(angular.isUndefined(prev))prev=true;var requestedIndex=null;var questionList=this.getFocusableQuestionList();if(null==this.focusQuestionId){if(0<questionList.length)requestedIndex=prev?questionList.length-1:0}else{var index=questionList.findIndexByProperty("id",this.focusQuestionId);var requestedIndex=prev?index-1:index+1}if(angular.isDefined(questionList[requestedIndex])){var question=questionList[requestedIndex];this.focusQuestionId=question.id;var element=document.getElementById("baseQuestion"+question.id);if(null!=element){element.scrollTop+=100;element.scrollIntoView(false)}}}})};return{instance:function(parentModel,root){return new object(parentModel,root)}}}]);cenozo.providers.decorator("CnPageAddFactory",["$delegate","CnSession",function($delegate,CnSession){var instance=$delegate.instance;$delegate.instance=function(parentModel){var object=instance(parentModel);object.baseOnNewFn=object.onNew;angular.extend(object,{onNew:async function(record){await this.baseOnNewFn(record);if(angular.isUndefined(record.max_time))record.max_time=CnSession.setting.defaultPageMaxTime}});return object};return $delegate}]);cenozo.providers.decorator("CnPageViewFactory",["$delegate","$filter","CnTranslationHelper",function($delegate,$filter,CnTranslationHelper){var instance=$delegate.instance;$delegate.instance=function(parentModel,root){var object=instance(parentModel,root);angular.extend(object,{onView:async function(force){await this.$$onView(force);this.record.average_time=$filter("cnSeconds")(Math.round(this.record.average_time));this.record.prompts=CnTranslationHelper.parseDescriptions(this.record.prompts);this.record.popups=CnTranslationHelper.parseDescriptions(this.record.popups);this.record.module_prompts=CnTranslationHelper.parseDescriptions(this.record.module_prompts);this.record.module_popups=CnTranslationHelper.parseDescriptions(this.record.module_popups)}});return object};return $delegate}]);cenozo.providers.decorator("CnPageModelFactory",["$delegate","CnPageRenderFactory","$state",function($delegate,CnPageRenderFactory,$state){function extendModelObject(object){angular.extend(object,{renderModel:CnPageRenderFactory.instance(object),getServiceResourceBasePath:function(resource){return"respondent"==this.getSubjectFromState()?"page/token="+$state.params.token:this.$$getServiceResourcePath(resource)},getServiceResourcePath:function(resource){return this.getServiceResourceBasePath(resource)},getServiceCollectionPath:function(ignoreParent){var path=this.$$getServiceCollectionPath(ignoreParent);if("respondent"==this.getSubjectFromState())path=path.replace("respondent/undefined","module/token="+$state.params.token);return path}});return object}var instance=$delegate.instance;$delegate.root=extendModelObject($delegate.root);$delegate.instance=function(parentModel,root){return extendModelObject(instance(root))};return $delegate}])}});
